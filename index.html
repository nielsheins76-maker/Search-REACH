<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemChecker Pro | Compliance Screening</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <style>
        body { background-color: #f8fafc; }
        
        /* Custom Scrollbar for tables */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            nav, .no-print, button, input[type="file"], .toast-container, .modal-overlay { display: none !important; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            #root { margin: 0; padding: 0; }
            .print-break-inside { page-break-inside: avoid; }
            td, th { color: black !important; border: 1px solid #e2e8f0 !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Search, AlertTriangle, CheckCircle, Ban, Users, Activity, Info, 
            ShieldCheck, Eraser, FileDown, Upload, Trash2, BookOpen, X,
            ClipboardCheck, FileText, ArrowRight, AlertOctagon, Database, Table, HardDrive, Loader2, Scale,
            Check, XCircle, CalendarClock, Gavel, FileSpreadsheet
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONSTANTS ---
        const INTERNAL_VERSION = "5.4 - CAS Validation + CSV"; 
        const SIX_MONTHS_MS = 15778800000; // Approx 6 months
        
        // --- DATABASE SETUP ---
        const db = new Dexie("ChemCheckerDB");
        db.version(2).stores({
            settings: 'id, value',
            substances: '++id, cas, name, listId' 
        });

        // --- UTILS: CAS VALIDATOR ---
        const validateCAS = (casString) => {
            if (!casString) return false;
            // 1. Clean string: remove anything that isn't a digit
            const digits = casString.replace(/[^\d]/g, '');
            
            // 2. Minimum length check (CAS is at least 5 digits: X-XX-X)
            if (digits.length < 5) return false;

            // 3. Extract check digit (last digit)
            const checkDigit = parseInt(digits.slice(-1), 10);
            
            // 4. Extract the core number (everything except last digit)
            const core = digits.slice(0, -1);

            // 5. Calculate checksum: sum(digit * position)
            // Reverse to make position calculation easy (1st from right, 2nd from right...)
            const sum = core.split('').reverse().reduce((acc, digit, idx) => {
                return acc + (parseInt(digit, 10) * (idx + 1));
            }, 0);

            // 6. Compare remainder
            return (sum % 10) === checkDigit;
        };

        // --- TOAST NOTIFICATION COMPONENT ---
        const ToastContainer = ({ toasts, removeToast }) => (
            <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 toast-container">
                {toasts.map(toast => (
                    <div key={toast.id} className={`flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-y-0 ${
                        toast.type === 'error' ? 'bg-red-600' : 
                        toast.type === 'success' ? 'bg-green-600' : 'bg-slate-800'
                    }`}>
                        {toast.type === 'success' && <Check size={18} />}
                        {toast.type === 'error' && <XCircle size={18} />}
                        {toast.type === 'info' && <Info size={18} />}
                        <span className="text-sm font-medium">{toast.message}</span>
                        <button onClick={() => removeToast(toast.id)} className="ml-2 hover:opacity-75"><X size={14}/></button>
                    </div>
                ))}
            </div>
        );

        // --- DISCLAIMER MODAL COMPONENT ---
        const DisclaimerModal = ({ onAccept }) => (
            <div className="fixed inset-0 z-[100] bg-slate-900/90 flex items-center justify-center p-4 backdrop-blur-sm modal-overlay">
                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-8 border-t-4 border-indigo-600">
                    <div className="flex items-center gap-3 mb-4 text-indigo-900">
                        <Gavel size={32} />
                        <h2 className="text-2xl font-bold">Legal Disclaimer</h2>
                    </div>
                    <div className="prose prose-sm text-slate-600 mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <p className="font-bold mb-2">Please read before proceeding:</p>
                        <ul className="list-disc pl-4 space-y-2">
                            <li>This software is a <strong>screening tool</strong> for informational purposes only.</li>
                            <li>It does <strong>not</strong> constitute legal advice or a guarantee of compliance.</li>
                            <li>Regulatory status (e.g., Annex XVII) depends on specific conditions of use (mixtures vs. articles) which this tool cannot verify.</li>
                            <li>Users must verify all results against official ECHA publications and legal texts.</li>
                        </ul>
                    </div>
                    <button 
                        onClick={onAccept}
                        className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2"
                    >
                        I Acknowledge & Accept <ArrowRight size={18} />
                    </button>
                </div>
            </div>
        );

        // --- REGULATORY KNOWLEDGE BASE ---
        const regulatoryInfo = {
            "annex xvii": { 
                category: "restricted", 
                title: "REACH Annex XVII (Restricted Uses)", 
                description: "Substance is restricted for specific applications or conditions.", 
                implication: "CONDITIONAL: Check Annex XVII Col 2. May be banned in consumer goods but allowed in industry.", 
                paperwork: "Statement of Compliance (SoC) proving use conditions met.", 
                riskColor: "text-red-700 bg-red-50 border-red-200" 
            },
            "pop": { 
                category: "prohibited", 
                title: "POPs Regulation (EU 2019/1021)", 
                description: "Persistent Organic Pollutants. Strict prohibition.", 
                implication: "BANNED: Often Trace Contaminant limit (UTC) applies (e.g. 10mg/kg).", 
                paperwork: "Supplier Declaration of Absence.", 
                riskColor: "text-red-900 bg-red-100 border-red-300" 
            },
            "annex xiv": { 
                category: "warning", 
                title: "REACH Annex XIV (Authorisation List)", 
                description: "Use banned after 'Sunset Date' without Authorisation.", 
                implication: "USE BAN: Cannot use without specific Authorisation number.", 
                paperwork: "Proof of Authorisation OR Article 33 Declaration.", 
                riskColor: "text-orange-700 bg-orange-50 border-orange-200" 
            },
            "annex vi": { 
                category: "classification", 
                title: "CLP Annex VI (Harmonised Classification)", 
                description: "Legally binding classification (CMR).", 
                implication: "Ensure SDS and Labels match harmonised classification.", 
                paperwork: "Up-to-date Safety Data Sheet (SDS).", 
                riskColor: "text-emerald-700 bg-emerald-50 border-emerald-200" 
            },
            "svhc": { 
                category: "watch", 
                title: "SVHC Candidate List (Art. 59)", 
                description: "Candidate substances for Annex XIV.", 
                implication: "Threshold >0.1% w/w triggers Article 33 & SCIP duties.", 
                paperwork: "Article 33 Declaration & SCIP Number.", 
                riskColor: "text-yellow-700 bg-yellow-50 border-yellow-200" 
            },
            "pic": { 
                category: "warning", 
                title: "PIC Regulation", 
                description: "Prior Informed Consent for export/import.", 
                implication: "Export requires notification and RIN.", 
                paperwork: "Export Notification Number (RIN).", 
                riskColor: "text-purple-700 bg-purple-50 border-purple-200" 
            },
            "annex iv": { 
                category: "low", 
                title: "REACH Annex IV (Exemptions)", 
                description: "Minimum risk substances.", 
                implication: "EXEMPT: Generally considered safe.", 
                paperwork: "None (Standard SDS).", 
                riskColor: "text-green-700 bg-green-50 border-green-200" 
            }
        };

        const App = () => {
            const [inputText, setInputText] = useState("");
            const [results, setResults] = useState([]);
            const [dbLoaded, setDbLoaded] = useState(false);
            const [recordCount, setRecordCount] = useState(0);
            const [lastUploadDate, setLastUploadDate] = useState("Never");
            const [lastUploadTimestamp, setLastUploadTimestamp] = useState(0);
            const [isLoading, setIsLoading] = useState(true);
            const [loadingMessage, setLoadingMessage] = useState("");
            const [activeGuideCategory, setActiveGuideCategory] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);

            // --- Toast Logic ---
            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 4000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            const isDataOutdated = () => {
                if (!lastUploadTimestamp) return false;
                const age = Date.now() - lastUploadTimestamp;
                return age > SIX_MONTHS_MS;
            };

            useEffect(() => {
                const initDB = async () => {
                    try {
                        const dateRecord = await db.settings.get("uploadDate");
                        const timestampRecord = await db.settings.get("uploadTimestamp");
                        const count = await db.substances.count();
                        
                        if (count > 0) {
                            setDbLoaded(true);
                            setRecordCount(count);
                            setLastUploadDate(dateRecord ? dateRecord.value : "Unknown");
                            setLastUploadTimestamp(timestampRecord ? timestampRecord.value : 0);
                        }
                    } catch (err) { 
                        console.error("DB Load Error", err); 
                        addToast("Failed to load local database", "error");
                    } 
                    finally { setIsLoading(false); }
                };
                initDB();
            }, []);

            const normalizeData = (rawData) => {
                let arr = rawData;
                if (!Array.isArray(arr) && arr?.data) arr = arr.data;
                if (Array.isArray(arr)) arr = arr.flat(Infinity);
                if (!Array.isArray(arr)) return [];

                return arr.map(item => {
                    const keys = Object.keys(item);
                    const casKey = keys.find(k => /cas/i.test(k) && !/name/i.test(k)); 
                    const listKey = keys.find(k => /list|reg/i.test(k));
                    const nameKey = keys.find(k => /name|substance/i.test(k) && !/list/i.test(k));
                    const ecKey = keys.find(k => /ec/i.test(k));
                    const noteKey = keys.find(k => /note|desc/i.test(k));
                    const limitKey = keys.find(k => /limit|thresh|waarde|val|conc|condition/i.test(k) && !/list|name|cas/i.test(k));

                    const rawCas = item[casKey] || item["CAS No"] || item["CAS Number"] || "";
                    
                    return {
                        casOriginal: rawCas,
                        cas: String(rawCas).replace(/[\s\u00A0]/g, "").toLowerCase(),
                        listId: item[listKey] || item["List Name"] || "Unknown List",
                        name: item[nameKey] || item["Substance Name"] || "Unknown Name",
                        ec: item[ecKey] || "",
                        note: item[noteKey] || "",
                        limit: limitKey ? item[limitKey] : ""
                    };
                }).filter(item => item.cas && item.cas.length > 3);
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setIsLoading(true);
                setLoadingMessage("Reading file...");

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        setLoadingMessage("Parsing JSON...");
                        let json;
                        try {
                            json = JSON.parse(e.target.result);
                        } catch (parseError) {
                            throw new Error("Invalid JSON file format");
                        }

                        setLoadingMessage("Normalizing data & extracting Limits...");
                        const normalized = normalizeData(json);
                        
                        if(normalized.length === 0) throw new Error("No valid substance data found in file");

                        setLoadingMessage("Indexing database (this may take a moment)...");
                        await db.substances.clear();
                        await db.substances.bulkAdd(normalized);

                        const dateStr = new Date().toLocaleDateString();
                        const timestamp = Date.now();
                        
                        await db.settings.put({ id: "uploadDate", value: dateStr });
                        await db.settings.put({ id: "uploadTimestamp", value: timestamp });
                        
                        setRecordCount(normalized.length);
                        setLastUploadDate(dateStr);
                        setLastUploadTimestamp(timestamp);
                        setDbLoaded(true);
                        
                        addToast(`Database updated with ${normalized.length} records!`, "success");
                    } catch (err) { 
                        addToast(err.message, "error"); 
                    } 
                    finally { setIsLoading(false); setLoadingMessage(""); }
                };
                reader.readAsText(file);
            };

            const clearDatabase = async () => {
                if(confirm("Are you sure you want to delete the local database? This cannot be undone.")) {
                    await db.substances.clear();
                    await db.settings.clear();
                    setDbLoaded(false);
                    setRecordCount(0);
                    setResults([]);
                    setLastUploadDate("Never");
                    addToast("Database cleared", "info");
                }
            }

            const getRegInfo = (listId) => {
                const id = String(listId || "").toLowerCase();
                if (id.includes("annex iv")) return regulatoryInfo["annex iv"];
                if (id.includes("annex xvii") || id.includes("restriction")) return regulatoryInfo["annex xvii"];
                if (id.includes("annex xiv") || id.includes("authorisation")) return regulatoryInfo["annex xiv"];
                if (id.includes("pop")) return regulatoryInfo["pop"];
                if (id.includes("pic")) return regulatoryInfo["pic"];
                if (id.includes("svhc") || id.includes("candidate")) return regulatoryInfo["svhc"];
                if (id.includes("annex vi")) return regulatoryInfo["annex vi"];
                return null; 
            };

            const determineRisk = (listId) => {
                const lowerList = String(listId || "").toLowerCase();
                if (lowerList.includes("pop")) return { level: "prohibited", action: "BANNED", desc: "Prohibited" };
                if (lowerList.includes("annex xvii") || lowerList.includes("restriction")) return { level: "restricted", action: "RESTRICTED", desc: "Conditional Restriction" };
                if (lowerList.includes("authorisation") || lowerList.includes("annex xiv")) return { level: "warning", action: "CHECK DUTIES", desc: "Authorisation / CMR Hazard" };
                if (lowerList.includes("svhc") || lowerList.includes("candidate")) return { level: "watch", action: "WATCH LIST", desc: "SVHC Candidate" };
                if (lowerList.includes("annex vi")) return { level: "classification", action: "HARMONISED (CLP)", desc: "Harmonised Classification" };
                if (lowerList.includes("annex iv")) return { level: "low", action: "EXEMPT", desc: "Exempt" };
                return { level: "unknown", action: "UNKNOWN", desc: `Listed in: ${listId}` };
            };

            // --- CSV EXPORT FUNCTION ---
            const exportCSV = () => {
                if (!results || results.length === 0) return;

                const headers = ["CAS Input", "Substance Name", "Status", "Risk Level", "Lists Found", "List Details"];
                
                // Construct CSV rows
                const rows = results.map(r => {
                    const lists = r.entries.map(e => e.listId).join('; ');
                    const details = r.entries.map(e => `${e.listId}: ${e.limit || 'No specific limit'}`).join(' | ');
                    
                    // Escape quotes and wrap in quotes for CSV safety
                    const safeName = `"${(r.name || "").replace(/"/g, '""')}"`;
                    const safeDetails = `"${details.replace(/"/g, '""')}"`;

                    return [
                        r.cas, 
                        safeName, 
                        r.action, 
                        r.riskLevel, 
                        `"${lists}"`, 
                        safeDetails
                    ].join(",");
                });

                const csvContent = [headers.join(","), ...rows].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                // Trigger download
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `Compliance_Report_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleSearch = async () => {
                if (!inputText.trim()) {
                    addToast("Please enter at least one CAS number", "error");
                    return;
                }
                setIsLoading(true);
                setLoadingMessage("Scanning database...");

                try {
                    const rawQueries = inputText.split(/[\n,;]+/).map(q => q.trim()).filter(q => q);
                    const cleanQueries = rawQueries.map(q => String(q).replace(/[\s\u00A0]/g, "").toLowerCase());

                    const dbMatches = await db.substances.where('cas').anyOf(cleanQueries).toArray();

                    const processedResults = rawQueries.map(originalQuery => {
                        const cleanQ = String(originalQuery).replace(/[\s\u00A0]/g, "").toLowerCase();
                        
                        // CAS VALIDATION CHECK
                        if (!validateCAS(cleanQ)) {
                            return {
                                cas: originalQuery,
                                name: "Invalid CAS Checksum",
                                entries: [],
                                riskLevel: "error",
                                action: "INVALID FORMAT",
                                found: false
                            };
                        }

                        const matches = dbMatches.filter(m => m.cas === cleanQ);

                        if (matches.length > 0) {
                            const entries = matches.map(m => ({ ...m, ...determineRisk(m.listId) }));
                            const uniqueMap = new Map();
                            entries.forEach(e => uniqueMap.set(e.listId.toLowerCase(), e));
                            
                            const uniqueEntries = Array.from(uniqueMap.values()).sort((a,b) => (
                                {prohibited:6, restricted: 5, warning:4, watch:3, classification:2, low:1, unknown:0}[b.level] - 
                                {prohibited:6, restricted: 5, warning:4, watch:3, classification:2, low:1, unknown:0}[a.level]
                            ));

                            return { 
                                cas: originalQuery, 
                                name: uniqueEntries[0].name, 
                                entries: uniqueEntries, 
                                riskLevel: uniqueEntries[0].level, 
                                action: uniqueEntries[0].action, 
                                found: true 
                            };
                        }
                        return { cas: originalQuery, name: "No Match Found", entries: [], riskLevel: "unknown", action: "NOT LISTED", found: false };
                    });
                    
                    setResults(processedResults);
                    addToast(`Check complete. ${processedResults.filter(r => r.found).length} substances found.`, "success");
                } catch (e) { 
                    console.error(e); 
                    addToast("An error occurred during search", "error"); 
                } 
                finally { setIsLoading(false); setLoadingMessage(""); }
            };
            
            const handleKeyDown = (e) => { if (e.key === 'Enter') handleSearch(); };
            
            const getStatusStyles = (level) => {
                switch(level) {
                    case 'prohibited': return { card: 'border-red-600', flag: 'bg-red-600 text-white', badge: 'bg-red-50 text-red-700', icon: <Ban className="text-red-600" /> };
                    case 'restricted': return { card: 'border-red-500', flag: 'bg-red-100 text-red-800', badge: 'bg-red-50 text-red-700', icon: <AlertOctagon className="text-red-500" /> };
                    case 'warning': return { card: 'border-orange-500', flag: 'bg-orange-500 text-white', badge: 'bg-orange-50 text-orange-800', icon: <AlertTriangle className="text-orange-600" /> };
                    case 'watch': return { card: 'border-yellow-400', flag: 'bg-yellow-400 text-black', badge: 'bg-yellow-50 text-yellow-800', icon: <Users className="text-yellow-600" /> };
                    case 'classification': return { card: 'border-emerald-500', flag: 'bg-emerald-500 text-white', badge: 'bg-emerald-50 text-emerald-700', icon: <Activity className="text-emerald-600" /> };
                    case 'low': return { card: 'border-green-500', flag: 'bg-green-500 text-white', badge: 'bg-green-50 text-green-700', icon: <CheckCircle className="text-green-600" /> };
                    case 'error': return { card: 'border-slate-400 border-dashed', flag: 'bg-slate-600 text-white', badge: 'bg-slate-100 text-slate-800', icon: <XCircle className="text-slate-400" /> };
                    default: return { card: 'border-slate-300', flag: 'bg-slate-500 text-white', badge: 'bg-slate-100', icon: <Info className="text-slate-400" /> };
                }
            };

            const getGuideTitle = () => {
                if(activeGuideCategory === 'prohibited') return "Prohibited (Red)";
                if(activeGuideCategory === 'restricted') return "Restricted / Conditional (Red)";
                if(activeGuideCategory === 'warning') return "Authorisation & Hazards (Orange)";
                if(activeGuideCategory === 'watch') return "SVHC Watch List (Yellow)";
                if(activeGuideCategory === 'classification') return "Harmonised (CLP) (Green)";
                return "Exemptions (Green)";
            }

            if (isLoading) return (
                <div className="min-h-screen flex flex-col items-center justify-center text-slate-500 font-sans bg-slate-50">
                    <Loader2 className="w-10 h-10 animate-spin text-indigo-600 mb-4" />
                    <h2 className="text-xl font-bold text-slate-700">{loadingMessage || "Loading System..."}</h2>
                    <p className="text-sm mt-2">Processing large dataset via IndexedDB</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col">
                    {!disclaimerAccepted && <DisclaimerModal onAccept={() => setDisclaimerAccepted(true)} />}
                    <ToastContainer toasts={toasts} removeToast={removeToast} />
                    
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm print:hidden">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <ShieldCheck className="text-indigo-600 w-8 h-8" />
                                <div>
                                    <h1 className="text-xl font-bold text-slate-900">ChemChecker <span className="text-indigo-600">Pro</span></h1>
                                    <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Compliance Screening Tool</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4 no-print">
                                <div className="hidden md:flex gap-2">
                                    <button onClick={() => setActiveGuideCategory('restricted')} className="px-2 py-1 rounded bg-red-100 text-red-700 text-xs font-bold hover:bg-red-200 border border-red-200 transition">Restricted</button>
                                    <button onClick={() => setActiveGuideCategory('warning')} className="px-2 py-1 rounded bg-orange-100 text-orange-700 text-xs font-bold hover:bg-orange-200 border border-orange-200 transition">Auth/Haz</button>
                                    <button onClick={() => setActiveGuideCategory('watch')} className="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-bold hover:bg-yellow-200 border border-yellow-200 transition">SVHC</button>
                                    <button onClick={() => setActiveGuideCategory('classification')} className="px-2 py-1 rounded bg-emerald-100 text-emerald-700 text-xs font-bold hover:bg-emerald-200 border border-emerald-200 transition">CLP</button>
                                </div>
                                <div className="h-6 w-px bg-slate-200"></div>
                                <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border ${isDataOutdated() ? 'bg-amber-50 border-amber-300' : 'bg-slate-100 border-slate-200'}`}>
                                    <Database size={16} className={dbLoaded ? (isDataOutdated() ? "text-amber-500" : "text-green-600") : "text-slate-400"} />
                                    <div className="text-xs">
                                        <span className="block font-bold text-slate-700">{dbLoaded ? `${recordCount.toLocaleString()} Records` : "No Data"}</span>
                                        <span className={`block text-[10px] ${isDataOutdated() ? "text-amber-700 font-bold" : "text-slate-500"}`}>
                                            Date: {lastUploadDate} {isDataOutdated() && "‚ö†Ô∏è OLD"}
                                        </span>
                                    </div>
                                    {dbLoaded && <button onClick={clearDatabase} className="ml-2 text-slate-400 hover:text-red-600 transition"><Trash2 size={16} /></button>}
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Guide Modal */}
                    {activeGuideCategory && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm no-print" onClick={() => setActiveGuideCategory(null)}>
                            <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 animate-fade-in" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6 border-b pb-4">
                                    <h3 className="text-xl font-bold flex items-center gap-2 text-slate-800"><BookOpen size={24} className="text-indigo-600"/> {getGuideTitle()}</h3>
                                    <button onClick={() => setActiveGuideCategory(null)}><X size={24} className="text-slate-400 hover:text-red-500 transition-colors"/></button>
                                </div>
                                <div className="space-y-6 max-h-[65vh] overflow-y-auto pr-2 custom-scrollbar">
                                    {Object.entries(regulatoryInfo).filter(([k, i]) => i.category === activeGuideCategory).map(([k, info]) => (
                                        <div key={k} className={`p-5 rounded-lg border border-l-4 ${info.riskColor} bg-opacity-10 shadow-sm`}>
                                            <div className="flex items-center gap-2 mb-2">
                                                <h4 className="font-bold text-base uppercase tracking-wide text-slate-900">{info.title}</h4>
                                            </div>
                                            <p className="text-sm text-slate-700 leading-relaxed mb-4">{info.description}</p>
                                            <div className="grid md:grid-cols-2 gap-4">
                                                <div className="bg-white p-3 rounded border border-indigo-100 shadow-sm">
                                                    <div className="flex items-center gap-2 mb-1 text-indigo-700 font-bold text-xs uppercase tracking-wider">
                                                        <ClipboardCheck size={14} /> ‚öñÔ∏è Legal Duty
                                                    </div>
                                                    <p className="text-xs text-slate-600 leading-snug">{info.implication}</p>
                                                </div>
                                                <div className="bg-white p-3 rounded border border-slate-200 shadow-sm">
                                                    <div className="flex items-center gap-2 mb-1 text-slate-700 font-bold text-xs uppercase tracking-wider">
                                                        <FileText size={14} /> üìÑ Paperwork
                                                    </div>
                                                    <p className="text-xs text-slate-600 leading-snug">{info.paperwork}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="flex-grow max-w-7xl w-full mx-auto px-4 py-8 space-y-8">
                        {isDataOutdated() && dbLoaded && (
                            <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg shadow-sm flex items-start gap-3 no-print">
                                <CalendarClock className="text-amber-600 flex-shrink-0" />
                                <div>
                                    <h3 className="font-bold text-amber-800">Database Outdated</h3>
                                    <p className="text-sm text-amber-700">Your regulatory data was uploaded over 6 months ago. REACH lists (SVHC, Annex XVII) change frequently. Please upload a new JSON export to ensure accurate screening.</p>
                                </div>
                            </div>
                        )}

                        {!dbLoaded && (
                            <div className="max-w-xl mx-auto text-center border-2 border-dashed border-slate-300 rounded-xl p-10 bg-white no-print shadow-sm hover:border-indigo-400 transition-colors">
                                <div className="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><HardDrive className="text-indigo-600 w-8 h-8" /></div>
                                <h2 className="text-xl font-bold text-slate-800">Initialize Screening Database</h2>
                                <p className="text-sm text-slate-500 mt-2 mb-6">Upload your massive JSON file. Data is indexed locally for instant search.</p>
                                <label className="cursor-pointer bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg inline-flex items-center gap-2 active:transform active:scale-95">
                                    <Upload size={18} /> Select Database File
                                    <input type="file" accept=".json" onChange={handleFileUpload} className="hidden" />
                                </label>
                            </div>
                        )}

                        {dbLoaded && (
                            <>
                                <section className="max-w-4xl mx-auto no-print">
                                    <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                                        <div className="p-1 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
                                        <div className="p-6">
                                            <label className="block font-semibold text-slate-700 mb-2">Quick Screen</label>
                                            <div className="relative">
                                                <input 
                                                    type="text"
                                                    className="w-full p-4 pr-12 border border-slate-200 bg-slate-50 rounded-xl text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all font-mono text-sm shadow-inner"
                                                    placeholder="Paste CAS numbers (e.g., 67-64-1, 50-00-0)"
                                                    value={inputText}
                                                    onChange={(e) => setInputText(e.target.value)}
                                                    onKeyDown={handleKeyDown}
                                                />
                                                <button onClick={() => {setInputText(""); setResults([]);}} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1"><Eraser size={18} /></button>
                                            </div>
                                            <div className="mt-4 flex justify-end">
                                                <button onClick={handleSearch} className="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2 active:transform active:scale-95 transition">
                                                    <Search size={18} /> Run Check
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                {results.length > 0 && (
                                    <section className="print:w-full">
                                        <div className="flex justify-between items-end border-b pb-4 mb-6">
                                            <div>
                                                <h2 className="text-2xl font-bold text-slate-800">Screening Report</h2>
                                                <p className="text-slate-500 text-sm">Generated on {new Date().toLocaleDateString()}</p>
                                            </div>
                                            <div className="flex gap-2 no-print">
                                                <button onClick={exportCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 flex items-center gap-2 transition shadow-sm">
                                                    <FileSpreadsheet size={18} /> Export CSV
                                                </button>
                                                <button onClick={() => window.print()} className="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-medium hover:bg-slate-200 flex items-center gap-2 transition">
                                                    <FileText size={18} /> Print PDF
                                                </button>
                                            </div>
                                        </div>

                                        <div className="grid gap-6">
                                            {results.map((item, idx) => {
                                                const styles = getStatusStyles(item.riskLevel);
                                                return (
                                                    <div key={idx} className={`bg-white rounded-xl shadow-sm border-l-8 ${styles.card} overflow-hidden print-break-inside`}>
                                                        <div className="flex">
                                                            <div className={`w-12 flex items-center justify-center bg-slate-50 print:bg-white print:border-r`}>
                                                                {styles.icon}
                                                            </div>
                                                            <div className="p-4 flex-grow">
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <h3 className="text-lg font-bold font-mono text-slate-900">{item.cas}</h3>
                                                                        <p className="text-sm text-slate-600 font-medium">{item.name}</p>
                                                                    </div>
                                                                    <span className={`px-3 py-1 rounded text-xs font-bold uppercase ${styles.badge} ${styles.flag}`}>
                                                                        {item.action}
                                                                    </span>
                                                                </div>
                                                                
                                                                {item.found && (
                                                                    <div className="mt-3 border-t pt-3">
                                                                        <table className="w-full text-sm text-left">
                                                                            <thead className="bg-slate-50 text-slate-500 font-medium">
                                                                                <tr>
                                                                                    <th className="px-4 py-2 w-1/4">Regulatory List</th>
                                                                                    <th className="px-4 py-2 w-1/4">Limit / Condition</th>
                                                                                    <th className="px-4 py-2">Obligations / Notes</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody className="divide-y divide-slate-50">
                                                                                {item.entries.map((entry, eIdx) => {
                                                                                    const regData = getRegInfo(entry.listId);
                                                                                    return (
                                                                                        <tr key={eIdx}>
                                                                                            <td className="px-4 py-2.5 font-medium text-slate-700 capitalize">
                                                                                                {entry.listId}
                                                                                                <span className="block text-[10px] text-slate-400 font-mono mt-0.5">{entry.ec || ""}</span>
                                                                                            </td>
                                                                                            <td className="px-4 py-2.5 text-slate-800">
                                                                                                {entry.limit ? (
                                                                                                    <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-slate-100 font-bold text-xs border border-slate-200">
                                                                                                        <Scale size={12} className="text-slate-500"/>
                                                                                                        {entry.limit}
                                                                                                    </span>
                                                                                                ) : (
                                                                                                    <span className="text-slate-300 text-xs">-</span>
                                                                                                )}
                                                                                            </td>
                                                                                            <td className="px-4 py-2.5 text-slate-600">
                                                                                                <div className="flex flex-col gap-1">
                                                                                                    {entry.note && <span className="text-xs italic text-slate-500 mb-1">{entry.note}</span>}
                                                                                                    {regData && (
                                                                                                        <>
                                                                                                            <div className="flex items-start gap-1.5 text-xs font-semibold text-indigo-700 bg-indigo-50 p-1.5 rounded">
                                                                                                                <ClipboardCheck size={14} className="flex-shrink-0 mt-0.5"/> 
                                                                                                                <span>{regData.implication}</span>
                                                                                                            </div>
                                                                                                            <div className="flex items-start gap-1.5 text-xs text-slate-600 bg-slate-50 p-1.5 rounded border border-slate-100">
                                                                                                                <FileText size={14} className="flex-shrink-0 mt-0.5"/>
                                                                                                                <span>Paperwork: {regData.paperwork}</span>
                                                                                                            </div>
                                                                                                        </>
                                                                                                    )}
                                                                                                </div>
                                                                                            </td>
                                                                                        </tr>
                                                                                    );
                                                                                })}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </section>
                                )}
                            </>
                        )}
                    </main>

                    <footer className="mt-auto py-8 border-t bg-white text-center print:border-none">
                        <h3 className="font-bold text-slate-800">ADDEV Materials Aerospace B.V.</h3>
                        <p className="text-xs text-slate-500 mt-1">Created by: N. Heins (HSE Specialist)</p>
                        <p className="text-xs text-slate-400 mt-2">Database: {dbLoaded ? `${recordCount.toLocaleString()} substances` : "Not Loaded"} ‚Ä¢ Last Upload: {lastUploadDate}</p>
                        <div className="mt-4 max-w-2xl mx-auto px-4">
                            <p className="text-[10px] text-slate-400 leading-relaxed border-t border-slate-100 pt-2">
                                <strong>DISCLAIMER:</strong> This tool is for preliminary screening only and does not constitute legal advice. 
                                Compliance with REACH, CLP, and other regulations depends on specific conditions of use, mixture concentrations, and regional laws. 
                                The user is solely responsible for verifying results against official ECHA publications and legal texts.
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
